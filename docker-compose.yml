services:
  # 1. Main Backend (Go)
  api:
    container_name: scv-api
    build:
      context: ./api
      dockerfile: Dockerfile
    restart: unless-stopped
    extra_hosts:
      - "localhost:host-gateway"
    environment:
      - TZ=${TZ:-Asia/Seoul}
      - DB_HOST=${DB_HOST:-db}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-scv_user}
      - DB_PASS=${DB_PASS:-scv_password}
      - DB_NAME=${DB_NAME:-scv_main}
      - VALKEY_HOST=${VALKEY_HOST:-valkey}
      - VALKEY_PORT=${VALKEY_PORT:-6379}
      - JWT_SECRET=${JWT_SECRET:-}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-*}
      - ONLYOFFICE_INTERNAL_URL=${ONLYOFFICE_URL:-http://onlyoffice}
      - ONLYOFFICE_PUBLIC_URL=${ONLYOFFICE_PUBLIC_URL:-}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - ${DATA_PATH:-./data}:/data
      - ${CONFIG_PATH:-./config}:/etc/scv
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      db:
        condition: service_healthy
      valkey:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # 2. Frontend (React + Express)
  ui:
    container_name: scv-ui
    build:
      context: ./ui
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${UI_PORT:-3080}:3000"
    environment:
      - TZ=${TZ:-Asia/Seoul}
      - API_URL=http://api:8080
      - ONLYOFFICE_URL=${ONLYOFFICE_URL:-http://onlyoffice}
      - ONLYOFFICE_PUBLIC_URL=${ONLYOFFICE_PUBLIC_URL:-}
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # 3. SMB Service (Sidecar)
  samba:
    container_name: scv-samba
    build:
      context: ./samba
      dockerfile: Dockerfile
    restart: unless-stopped
    network_mode: host
    environment:
      - TZ=${TZ:-Asia/Seoul}
      - WORKGROUP=${SMB_WORKGROUP:-WORKGROUP}
    volumes:
      - ${DATA_PATH:-./data}:/data
      - ${CONFIG_PATH:-./config}:/etc/scv
      - ${CONFIG_PATH:-./config}/smb.conf:/etc/samba/smb.conf:ro

  # 4. Database (PostgreSQL)
  db:
    container_name: scv-db
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Asia/Seoul}
      - POSTGRES_USER=${DB_USER:-scv_user}
      - POSTGRES_PASSWORD=${DB_PASS:-scv_password}
      - POSTGRES_DB=${DB_NAME:-scv_main}
    volumes:
      - ${DATABASE_PATH:-./database}:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-scv_user} -d ${DB_NAME:-scv_main}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 5. Cache & Queue (Valkey)
  valkey:
    container_name: scv-valkey
    image: valkey/valkey:8-alpine
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Asia/Seoul}
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # 6. OnlyOffice Document Server (Optional - use: docker compose --profile office up -d)
  onlyoffice:
    container_name: scv-onlyoffice
    image: onlyoffice/documentserver:latest
    restart: unless-stopped
    profiles:
      - office
    ports:
      - "${ONLYOFFICE_PORT:-8088}:80"
    environment:
      - TZ=${TZ:-Asia/Seoul}
      - JWT_ENABLED=false
      - ALLOW_PRIVATE_IP_ADDRESS=true
      - ALLOW_META_IP_ADDRESS=true
      - USE_UNAUTHORIZED_STORAGE=true
      - WOPI_ENABLED=false
    volumes:
      - onlyoffice_data:/var/www/onlyoffice/Data
      - onlyoffice_log:/var/log/onlyoffice
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  onlyoffice_data:
  onlyoffice_log:
