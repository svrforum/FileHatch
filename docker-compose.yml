# FileHatch Production Docker Compose
# Uses pre-built images from Docker Hub
#
# Usage:
#   docker compose up -d                    # Start core services
#   docker compose --profile office up -d   # With OnlyOffice
#   docker compose --profile sso up -d      # With Keycloak SSO
#
# For development (with local builds):
#   docker compose -f docker-compose-dev.yaml up -d

services:
  # 1. Main Backend (Go)
  api:
    container_name: fh-api
    image: svrforum/filehatch-api:${IMAGE_TAG:-latest}
    restart: unless-stopped
    extra_hosts:
      - "localhost:host-gateway"
    environment:
      - TZ=${TZ:-Asia/Seoul}
      - DB_HOST=${DB_HOST:-db}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-fh_user}
      - DB_PASS=${DB_PASS:-fh_password}
      - DB_NAME=${DB_NAME:-fh_main}
      - VALKEY_HOST=${VALKEY_HOST:-valkey}
      - VALKEY_PORT=${VALKEY_PORT:-6379}
      - JWT_SECRET=${JWT_SECRET:-}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-*}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-}
      - ONLYOFFICE_INTERNAL_URL=${ONLYOFFICE_URL:-http://onlyoffice}
      - ONLYOFFICE_PUBLIC_URL=${ONLYOFFICE_PUBLIC_URL:-}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - EXTERNAL_URL=${EXTERNAL_URL:-}
    volumes:
      - ${DATA_PATH:-./data}:/data
      - ${CONFIG_PATH:-./config}:/etc/filehatch
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      db:
        condition: service_healthy
      valkey:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # 2. Frontend (React + Express)
  ui:
    container_name: fh-ui
    image: svrforum/filehatch-ui:${IMAGE_TAG:-latest}
    restart: unless-stopped
    ports:
      - "${UI_PORT:-3080}:3000"
    environment:
      - TZ=${TZ:-Asia/Seoul}
      - API_URL=http://api:8080
      - ONLYOFFICE_URL=${ONLYOFFICE_URL:-http://onlyoffice}
      - ONLYOFFICE_PUBLIC_URL=${ONLYOFFICE_PUBLIC_URL:-}
      - EXTERNAL_URL=${EXTERNAL_URL:-}
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # 3. SMB Service (Sidecar)
  samba:
    container_name: fh-samba
    image: svrforum/filehatch-samba:${IMAGE_TAG:-latest}
    restart: unless-stopped
    network_mode: host
    environment:
      - TZ=${TZ:-Asia/Seoul}
      - WORKGROUP=${SMB_WORKGROUP:-WORKGROUP}
    volumes:
      - ${DATA_PATH:-./data}:/data
      - ${CONFIG_PATH:-./config}:/etc/filehatch
      - ${CONFIG_PATH:-./config}/smb.conf:/etc/samba/smb.conf:ro

  # 4. Database (PostgreSQL)
  db:
    container_name: fh-db
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Asia/Seoul}
      - POSTGRES_USER=${DB_USER:-fh_user}
      - POSTGRES_PASSWORD=${DB_PASS:-fh_password}
      - POSTGRES_DB=${DB_NAME:-fh_main}
    volumes:
      - ${DATABASE_PATH:-./database}:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-fh_user} -d ${DB_NAME:-fh_main}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 5. Cache & Queue (Valkey)
  valkey:
    container_name: fh-valkey
    image: valkey/valkey:8.1.5-alpine
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Asia/Seoul}
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # 6. OnlyOffice Document Server (Optional - use: docker compose --profile office up -d)
  onlyoffice:
    container_name: fh-onlyoffice
    image: onlyoffice/documentserver:9.2.1
    restart: unless-stopped
    profiles:
      - office
    ports:
      - "${ONLYOFFICE_PORT:-8088}:80"
    environment:
      - TZ=${TZ:-Asia/Seoul}
      - JWT_ENABLED=false
      - ALLOW_PRIVATE_IP_ADDRESS=true
      - ALLOW_META_IP_ADDRESS=true
      - USE_UNAUTHORIZED_STORAGE=true
      - WOPI_ENABLED=false
    volumes:
      - onlyoffice_data:/var/www/onlyoffice/Data
      - onlyoffice_log:/var/log/onlyoffice
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 7. Keycloak SSO Server (Optional - use: docker compose --profile sso up -d)
  keycloak:
    container_name: fh-keycloak
    image: quay.io/keycloak/keycloak:26.5.1
    restart: unless-stopped
    profiles:
      - sso
    ports:
      - "${KEYCLOAK_PORT:-8180}:8080"
    environment:
      - TZ=${TZ:-Asia/Seoul}
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin123}
      - KC_HTTP_RELATIVE_PATH=/auth
      - KC_HOSTNAME=${KEYCLOAK_HOSTNAME:-localhost}
      - KC_HOSTNAME_PORT=${KEYCLOAK_PORT:-8180}
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
      - KC_HTTP_ENABLED=true
      - KC_PROXY_HEADERS=xforwarded
    command:
      - start-dev
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /auth/health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && timeout 1 cat <&3 | grep -q '200\\|UP' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    volumes:
      - keycloak_data:/opt/keycloak/data

volumes:
  onlyoffice_data:
  onlyoffice_log:
  keycloak_data:
